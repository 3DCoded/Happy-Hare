# Slicer Setup
- [Start G-Code](#)<br>
  - [Placeholder Pre-Processing](#---placeholder-pre-processing)<br>
- [End G-Code](#)<br>
- [Toolchange G-Code](#)<br>
- [Customizing MMU Start/End Macros](#)<br>
- [MMU Error Dialog](#)<br>

When printing with an MMU you must augment the gcode generated by your slicer to include logic to initialize the MMU, load the initial filament and optionally reset and eject filament at the end of the print. To achive that it is necessary to enable MMU support in your slicer and then edit the custom g-code. While there are many ways to do this, Happy Hare recommends the following inorder to take advantage of all the advanced features.

## ![#f03c15](/doc/f03c15.png) ![#c5f015](/doc/c5f015.png) ![#1589F0](/doc/1589F0.png) Custom Start G-Code

Make sure the advanced options of your slicer are enabled and enter the following into your "custom start g-code" box:

<img src="/doc/slicer/start_gcode.png" width="400" alt="Custom Start G-Code">
*** Your `PRINT_START ...` macro is likely to be different from mine

> [!NOTE]  
> The reason that it is recommended to add these 4 or 5 lines to your slicer is to keep them as separate gcode macros to enable the print to pause in the case of an error.  If you bundle everything into a single print start macro then the first opportunity to pause will be at the end of that, potentially long running, macro!

`1. MMU_START_SETUP`
This is a macro (defined in `mmu_software.cfg`) that is passed information either through slicer "placeholder" variables delimited by `{}` like `{initial_tool}` or though a similar mechanism implemented by Happy Hare moonraker extension which pre-processes the g-code file when it is uploaded and substitutes placeholders that are useful for MMU printing but, unfortunately, are absent in all popular slicer programs. These placeholders are variables delimied by `!!` like `!referenced_tools!`

This macro initializes the MMU, establishes whether the print is single or multi-color, detects when the intent is to print bypassing the MMU and then stores this infomation in Happy Hare for the duration of the print in the "Slicer Tool Map". This can be accessed in your own macros through the `printer.mmu.slicer_tool_map` printer variable. E.g.

> printer.mmu.slicer_tool_map.
>    initial_tool: 0     ; Number of initial tool that is expected to be loaded at the beginning of the print
>    tools               ; List of all the tools referenced in the print (T0 and T3)
>      0.color: ff0000   ; Color in RRGGBB format for T0
>      0.material: ABS   ; Material type for T0
>      0.temp: 240       ; Extruder temperature for T0
>      3.color: 00e410   ; Color in RRGGBB format for T3
>      3.material: ASA   ; Material type for T3
>      3.temp: 245       ; Extruder temperature for T3

> [!TIP]  
> The "Slicer Tool Map" can be displayed on the console at any time during the print by running the `MMU_SLICER_TOOL_MAP` command without any parameters:
> MMU_SLICER_TOOL_MAP
> --------- Slicer MMU Tool Summary ---------
> 2 color print
> T0 (Gate 0, ABS, ff0000, 240°C)
> T3 (Gate 3, ASA, 00e410, 245°C)
> Initial Tool: T0
> -------------------------------------------


`2. MMU_START_CHECK`
This macro uses the "Slicer Tool Map" and performs checks to ensure the MMU is fully ready to print. Currently checks are limited to confirming that filament is available in all the required tools, but in the future it might check that the filaments types the sliced g-code expects match those actually loaded in the MMU (think how the Spoolman integration could be used...)
If this macro fails, the print will pause but not abort or skip the rest of the startup sequence. 

> [!TIP]  
> On failure while in a paused state, you can run this macro by hand to repeat the checks. Simply run `MMU_START_CHECK` without any parameters

`3. PRINT_START...`
This is where you put your normal print start macro passing additional slicer placeholders. This macro doesn't need anything added for MMU support, but note that it should not assume the extruder is loaded with filament. Activities like purging should be separated out and included later.

`4. MMU_START_LOAD_INITIAL_TOOL`
This macro will load the initial tool used by the print. No need to pass it any information - it retrieves it from the "Slicer Tool Map" setup earlier

`5. optional purge logic...
Optionally you can put the parts of your original print start macro that you separated out here. Typically this would be the logic that purges the nozzle and prints prime line. Although not technically required for MMU prints it is nice to retain for when using the bypass on special single color prints.


### Placeholder Pre-Processing
XXX TODO

> [!IMPORTANT]  
> The Happy Hare moonraker g-code pre-processor (that's quite a mouthful) takes only a few seconds to process even with large g-code files, however, because of the way moonraker works it is important that your workflow is "Upload" and then "Print" rather than the combined "Upload and Print". The latter will result in the !placeholders! not being expanded in time.


## ![#f03c15](/doc/f03c15.png) ![#c5f015](/doc/c5f015.png) ![#1589F0](/doc/1589F0.png) Custom End G-Code

Ensure this is added in your slicer's "custom end g-code" box:

<img src="/doc/slicer/end_gcode.png" width="400" alt="Custom End G-Code">

`1. MMU_END`
This is a macro (defined in `mmu_software.cfg`) that finalizes MMU, can print stats, reset any TTG map and eject filament. It is recommended to run this before your existing print end macro which is likely to disable heaters and turn motors off.

`2. PRINT_END...`
This is where you existing print end macro would be placed


## ![#f03c15](/doc/f03c15.png) ![#c5f015](/doc/c5f015.png) ![#1589F0](/doc/1589F0.png) Custom tool change G-Code

This is likely to be the slicer default, but it is worth checking that the custom tool change g-code is set to this:

<img src="/doc/slicer/tool_change_gcode.png" width="300" alt="Custom Tool Change G-Code">


## ![#f03c15](/doc/f03c15.png) ![#c5f015](/doc/c5f015.png) ![#1589F0](/doc/1589F0.png) Customing MMU Start/End Macros

The recommended macro described here can be customized in `mmu_macro_vars.cfg`. Look for the `_MMU_SOFTWARE_VARS` section (corresponding to `mmu_software.cfg`) 

```yml
# PRINT START/END ---------------------------------------------------------
#   (base/mmu_software.cfg)
#
[gcode_macro _MMU_SOFTWARE_VARS]
description: Happy Hare optional configuration for print start/end checks
gcode: # Leave empty

# These variables control the behavor of the optional _MMU_INITIALIZE and _MMU_LOAD_INITIAL_TOOL macros
variable_user_pre_initialize_extension      : "G28"     ; Executed at start of _MMU_INITIALIZE. Commonly G28 to home
variable_octoprint_compat                   : True      ; True to force compatibility with Octoprint print job streaming
variable_set_custom_colors                  : True      ; True to set the gate custom_colors according to slicer
variable_home_mmu                           : False     ; True/False, Whether to home mmu before print starts
variable_check_gates                        : True      ; True/False, Whether to check filament is loaded in all gates used
variable_load_initial_tool                  : True      ; True/False, Whether to automatically load initial tool

# These variables control the behavor of the optional _MMU_FINALIZE macro
variable_eject_tool                         : True      ; True/False, Whether to eject the tool at the end of the print
variable_reset_ttg                          : False     ; True/False, Whether reset TTG map at end of print
variable_dump_stats                         : True      ; True/False, Whether to display print stats at end of print
```

## ![#f03c15](/doc/f03c15.png) ![#c5f015](/doc/c5f015.png) ![#1589F0](/doc/1589F0.png) MMU Error Dialog

When Happy Hare detects an error, even during print start it will pause the print allowing you to fix and then resume. If the option `show_error_dialog: 1` is set in `mmu_parameters.cfg` a pop-up dialog will be displayed on Mailsail/Fluidd/KlipperScreen providing you options through the UI. If it is occurs during these startup macros there will also be an option to abort the print. The abort option will disappear during the print. To disable the popup, set `show_error_dialog: 0`

<img src="/doc/slicer/tool_change_gcode.png" width="300" alt="Custom Tool Change G-Code">
